<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin_layout}">
<head>
    <title>Menu</title>
</head>
<body th:with="currentPage = 'ADMIN'">
<main layout:fragment="content" role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4" id="menu">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">메뉴관리</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group mr-2">
                <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>
                <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle">
                <span data-feather="calendar"></span>
                This week
            </button>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 col-lg-3 d-md-block">
                <!--<div class="mb-3 text-right">
                    <button type="button" class="btn btn-sm btn-primary createNode">추가</button>
                    <button type="button" class="btn btn-sm btn-secondary">삭제</button>
                </div>-->
                <div ref="menuTree">
                    tree
                </div>
            </div>
            <div class="col-md-9 ml-sm-auto col-lg-9 px-md-4">
                <form>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="menuName">Menu Name</label>
                            <input type="text" class="form-control" id="menuName" v-model="params.menuName">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="menuDesc">Menu Desc</label>
                            <input type="text" class="form-control" id="menuDesc" v-model="params.menuDesc">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="menuUrl">Menu Url</label>
                            <input type="text" class="form-control" id="menuUrl" v-model="params.menuUrl">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="roleMenu">Menu Role</label>
                            <select id="roleMenu" class="form-control" v-model="params.menuRole">
                                <option th:each="item : ${roles}" th:value="${item.roleCode}" th:text="${item.roleName}">roleName</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-3">
                            <label for="parent">Parent</label>
                            <input type="text" class="form-control" id="parent" v-model="params.parent">
                        </div>
                        <div class="form-group col-md-3">
                            <label for="sortNo">Sort No</label>
                            <input type="text" class="form-control" id="sortNo" v-model="params.sortOrderNo">
                        </div>
                        <div class="form-group col-md-3">
                            <label for="sortNo">Menu Icon</label>
                            <input type="text" class="form-control" id="sortNo" v-model="params.menuIcon">
                        </div>
                        <div class="form-group col-md-3">
                            <label for="useFlag">Use Flag</label>
                            <select id="useFlag" class="form-control" v-model="params.useFlag">
                                <option :value="true">Yes</option>
                                <option :value="false">No</option>
                            </select>
                        </div>
                    </div>
                    <div class="text-right">
                        <button type="button" class="btn btn-primary" @click="saveMenu('post')">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>

<th:block layout:fragment="script">
    <script th:inline="javascript" type="text/javascript">
        /*<![CDATA[*/
        var vue = new Vue({
            el: "#menu",
            data: {
                params: {
                    id: null,
                    menuName: null,
                    menuDesc: null,
                    menuRole: null,
                    menuUrl: null,
                    menuIcon: null,
                    parent: null,
                    useFlag: null,
                    sortOrderNo: null,
                    menuLevelNo: 0,
                    status: null
                },
                treeData: [],
                menuTree: false
            },
            watch: {
                'params.menuName': function (val) {
                    this.$nextTick(function () {
                        try {
                            var node = $(this.$refs.menuTree).jstree(true).get_node(this.params.id);
                            $(this.$refs.menuTree).jstree(true).rename_node(node, val);
                        } catch (error) {
                            console.log(error);
                        };
                    })
                }
            },
            methods: {
                loadData: function () {
                    var that = this;

                    hams.ajax({
                        type: "get",
                        url:'/admin/menu/api',
                        success: function(data, textStatus, jqXhr){
                            that.createJstree(data);
                        },
                        error:function(xhr,status,error){
                            console.log(xhr)
                            if (error != null) {
                                bootbox.alert(xhr.responseJSON.error);
                            }
                        }
                    });

                },
                setData: function (node) {
                    console.log("setData", node);

                    var data;
                    
                    if (node.original) {
                        data = node.original;
                        this.params.id = data.id ? data.id : node.id;
                        this.params.menuDesc = data.menuDesc;
                        this.params.menuName = node.text;
                        this.params.menuUrl = data.menuUrl;
                        this.params.menuRole = data.menuRole;
                        this.params.menuIcon = data.menuIcon;
                        this.params.parent = node.parent;
                        this.params.sortOrderNo = data.sortOrderNo;
                        this.params.useFlag = data.useFlag;
                        this.params.menuLevelNo = node.parents.length - 1;
                        this.params.status = node.status;
                    }
                },
                saveMenu: function (type, node) {
                    var that = this;
                    var param = this.params;

                    if (param.status == "create") {
                        // 생성된 id는 j1_1과 같이 시작하기 때문에 null 처리함 
                        // jpa strategy = GenerationType.IDENTITY로 신규 ID 생성
                        param.id = null;
                    }

                    console.log(param);
                    hams.ajax({
                        type: type ? type : "post",
                        url:'/admin/menu/api',
                        data: JSON.stringify(param),
                        success: function(data, textStatus, jqXhr){
                            console.log("success", data);
                            bootbox.alert("저장되었습니다.", function () {
                                that.loadData();
                            });
                        },
                        error:function(xhr,status,error){
                            console.log("error", xhr);
                            if (error != null) {
                                bootbox.alert(xhr.responseJSON.error);
                            }
                        }
                    });

                },
                createJstree: function (data) {
                    // console.log("createJstree", data);
                    var that = this;
                    this.treeData = data.data;

                    if (this.menuTree) {
                        $(this.$refs.menuTree).jstree(true).settings.core.data = this.treeData;
                        $(this.$refs.menuTree).jstree(true).refresh();

                        return;
                    }

                    this.menuTree = true;

                    // this.menuTree = $(this.$refs.menuTree);
                    $(this.$refs.menuTree).jstree({
                        'core': {
                            "check_callback" : true,
                            'data': that.treeData
                        },
                        "plugins" : [ "contextmenu" ],

                    }).on('select_node.jstree', function (evt, data, x) {
                        console.log("select_node", data);
                        that.setData(data.node);
                    }).on('loaded.jstree', function (evt, data) {
                        // $(this).jstree('open_all');
                        var rootNode = $(this).jstree(true).get_node("1");

                        if (rootNode) {
                            $(this).jstree(true).select_node("1");
                            $(this).jstree(true).open_node("1");
                        }
                    }).on('create_node.jstree', function (evt, data) {
                        console.log("create_node", data);
                        var parent = data.parent;
                        var childrenLength = $(this).jstree(true).get_node(parent).children.length;

                        console.log(childrenLength)
                        data.node.original.sortOrderNo = childrenLength;
                        data.node.status = "create";
                        that.setData(data.node);
                    }).on('delete_node.jstree', function (evt, data) {
                        console.log("delete_node", data);

                        if (data.node.status != "create") {
                            that.saveMenu("delete", data);
                        }
                        
                    }).on('rename_node.jstree', function (evt, data) {
                        var nodeId = data.node.id;
                        $(this).jstree(true).deselect_all();
                        $(this).jstree(true).select_node(nodeId);
                    }).on('edit_node.jstree', function (evt, data) {
                    }).on('move_node.jstree', function (evt, data) {
                    }).on('open_node.jstree', function (evt, data) {
                    });
                }
            },
            created: function () {
                this.loadData();
            },
            mounted: function () {
                var that = this;

            }
        });
        /*]]>*/
    </script>
</th:block>
</body>
</html>